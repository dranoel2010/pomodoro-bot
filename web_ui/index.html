<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS Advanced Interface</title>
    <style>
        :root {
            --glow-color: #00f2ff;
            --bg-color: #050a0f;
            --secondary-glow: rgba(0, 242, 255, 0.5);
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            overflow: hidden;
            font-family: "Orbitron", "Segoe UI", sans-serif;
            transition: background-color 0.8s ease;
        }

        body {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        body.light-bright {
            background-color: #0a1a2a;
        }

        body.light-dark {
            background-color: #020508;
        }

        .aq-good {
            --glow-color: #00f2ff;
            --secondary-glow: rgba(0, 242, 255, 0.5);
        }

        .aq-bad {
            --glow-color: #ff4d00;
            --secondary-glow: rgba(255, 77, 0, 0.5);
        }

        .status-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: var(--glow-color);
            letter-spacing: 2px;
            text-shadow: 0 0 5px var(--glow-color);
            z-index: 25;
        }

        .status-title {
            font-size: 2rem;
            letter-spacing: 4px;
            line-height: 1;
        }

        .status-label {
            display: inline-block;
            margin-top: 26px;
            padding: 3px 10px;
            border: 1px solid var(--glow-color);
            border-radius: 999px;
            background: rgba(0, 242, 255, 0.08);
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: inset 0 0 8px rgba(0, 242, 255, 0.2);
        }

        .connection-display {
            position: absolute;
            top: 20px;
            left: 20px;
            text-align: left;
            color: var(--glow-color);
            text-shadow: 0 0 5px var(--glow-color);
            z-index: 25;
        }

        .connection-line {
            font-size: 0.7rem;
            margin-top: 5px;
            max-width: min(45vw, 460px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .connection-line.muted {
            opacity: 0.7;
        }

        .connection-line.ws {
            opacity: 0.9;
            color: #ff4d00;
        }

        .pomodoro-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(92vw, 980px);
            color: var(--glow-color);
            text-align: center;
            text-shadow: 0 0 12px rgba(0, 242, 255, 0.25);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.35s ease, transform 0.35s ease;
            z-index: 12;
            pointer-events: none;
        }

        .pomodoro-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -51%);
        }

        .pomodoro-session {
            font-size: clamp(0.8rem, 1.8vw, 1.1rem);
            letter-spacing: 3px;
            opacity: 0.95;
            text-transform: uppercase;
        }

        .pomodoro-timer {
            font-size: clamp(4.2rem, 17vw, 11rem);
            font-weight: 700;
            line-height: 1;
            margin-top: 8px;
            letter-spacing: 0.06em;
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.35);
        }

        .pomodoro-phase {
            display: inline-block;
            margin-top: 10px;
            padding: 4px 12px;
            border: 1px solid rgba(0, 242, 255, 0.7);
            border-radius: 999px;
            background: rgba(0, 242, 255, 0.08);
            font-size: 0.68rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .pomodoro-motivation {
            margin: 16px auto 0;
            max-width: min(90vw, 860px);
            font-size: clamp(0.82rem, 1.8vw, 1.15rem);
            line-height: 1.45;
            letter-spacing: 1px;
            opacity: 0.95;
        }

        .conversation-display {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: min(92vw, 1000px);
            text-align: center;
            color: var(--glow-color);
            text-shadow: 0 0 5px var(--glow-color);
            z-index: 25;
        }

        .conversation-line {
            font-size: 0.7rem;
            opacity: 0.85;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-line.error {
            opacity: 0.95;
            color: #ff4d00;
        }

        .container {
            position: relative;
            width: 70vw;
            height: 70vw;
            max-width: 500px;
            max-height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 6;
            transition: all 0.4s ease;
        }

        .container::before {
            content: "";
            position: absolute;
            inset: 12%;
            border: 1px solid rgba(0, 242, 255, 0.22);
            background-image:
                repeating-linear-gradient(0deg,
                    rgba(0, 242, 255, 0.06) 0,
                    rgba(0, 242, 255, 0.06) 1px,
                    transparent 1px,
                    transparent 14px),
                repeating-linear-gradient(90deg,
                    rgba(0, 242, 255, 0.06) 0,
                    rgba(0, 242, 255, 0.06) 1px,
                    transparent 1px,
                    transparent 14px);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.35s ease;
            pointer-events: none;
        }

        body.pomodoro-focus .container {
            position: absolute;
            top: auto;
            bottom: 20px;
            right: 20px;
            width: min(28vw, 170px);
            height: min(28vw, 170px);
            max-width: none;
            max-height: none;
            opacity: 0.82;
            filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.35));
        }

        body.pomodoro-focus .container::before {
            opacity: 1;
        }

        body.pomodoro-focus .status-display {
            opacity: 0.8;
        }

        svg {
            width: 100%;
            height: 100%;
            transition: filter 0.5s ease;
        }

        .ring {
            transform-origin: center;
            transition: all 0.5s ease;
            stroke: var(--glow-color);
        }

        .core {
            transform-origin: center;
            fill: var(--glow-color);
            transition: all 0.5s ease;
        }

        @keyframes rotate-cw {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @keyframes rotate-ccw {
            from {
                transform: rotate(360deg);
            }

            to {
                transform: rotate(0deg);
            }
        }

        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 0.6;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        .state-idle .ring-outer {
            animation: rotate-cw 20s linear infinite;
        }

        .state-idle .core {
            animation: pulse-soft 3s ease-in-out infinite;
        }

        .state-listening .ring-middle {
            animation: rotate-cw 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            stroke-width: 12;
            opacity: 0.8;
        }

        .state-listening .core {
            transform: scale(1.2);
            filter: blur(2px);
        }

        .state-transcribing .ring-middle {
            animation: rotate-cw 1.2s linear infinite;
            stroke-width: 10;
            opacity: 0.85;
        }

        .state-transcribing .core {
            transform: scale(1.15);
        }

        .state-thinking .ring-outer {
            animation: rotate-cw 3s linear infinite;
            stroke-dasharray: 20, 50;
        }

        .state-thinking .ring-inner {
            animation: rotate-ccw 1.5s linear infinite;
            stroke-dasharray: 10, 10;
        }

        .state-replying .core {
            animation: pulse-soft 0.3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px var(--glow-color));
        }

        .state-replying .ring-outer {
            transform: scale(1.1);
            opacity: 0.4;
        }

        .state-error {
            --glow-color: #ff4d00;
            --secondary-glow: rgba(255, 77, 0, 0.5);
        }

        .state-error .core {
            animation: pulse-soft 0.4s ease-in-out infinite;
            filter: drop-shadow(0 0 18px var(--glow-color));
        }

        @media (max-width: 720px) {
            .status-display {
                top: 12px;
            }

            .status-title {
                font-size: 1.35rem;
                letter-spacing: 2px;
            }

            .status-label {
                margin-top: 18px;
            }

            .connection-display {
                top: 12px;
                left: 12px;
            }

            .connection-line {
                max-width: 56vw;
            }

            .conversation-display {
                bottom: 12px;
            }

            .pomodoro-panel {
                width: 95vw;
            }

            body.pomodoro-focus .container {
                top: auto;
                bottom: 12px;
                right: 12px;
                width: min(30vw, 128px);
                height: min(30vw, 128px);
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>

<body class="light-dark aq-good">
    <div class="status-display">
        <div class="status-title">J.A.R.V.I.S.</div>
        <div id="main-status" class="status-label">IDLE</div>
    </div>

    <div class="connection-display">
        <div id="env-status" class="connection-line muted">Listening for events</div>
        <div id="ws-indicator" class="connection-line ws">WS: DISCONNECTED</div>
    </div>

    <div id="pomodoro-panel" class="pomodoro-panel">
        <div id="pomodoro-session" class="pomodoro-session">FOCUS SESSION</div>
        <div id="pomodoro-timer" class="pomodoro-timer">25:00</div>
        <div id="pomodoro-phase" class="pomodoro-phase">IDLE</div>
        <div id="pomodoro-motivation" class="pomodoro-motivation">Start a session to lock in your focus.</div>
    </div>

    <div class="conversation-display">
        <div id="last-transcript" class="conversation-line">TRANSCRIPT: -</div>
        <div id="last-reply" class="conversation-line">REPLY: -</div>
        <div id="last-error" class="conversation-line error" style="display: none;"></div>
    </div>

    <div class="container state-idle" id="jarvis-container">
        <svg viewBox="0 0 400 400" id="jarvis-svg">
            <defs>
                <radialGradient id="coreGradient">
                    <stop offset="0%" stop-color="white" />
                    <stop offset="100%" stop-color="var(--glow-color)" />
                </radialGradient>
            </defs>

            <circle cx="200" cy="200" r="195" fill="none" stroke="var(--secondary-glow)" stroke-width="0.5"
                stroke-dasharray="2, 5" />
            <circle class="ring ring-outer" cx="200" cy="200" r="160" fill="none" stroke-width="2"
                stroke-dasharray="100, 20" />
            <circle class="ring ring-middle" cx="200" cy="200" r="130" fill="none" stroke-width="5"
                stroke-dasharray="40, 10" opacity="0.6" />
            <circle class="ring ring-inner" cx="200" cy="200" r="90" fill="none" stroke-width="1"
                stroke-dasharray="5, 5" />

            <g id="core-group">
                <circle class="core" cx="200" cy="200" r="35" opacity="0.9" fill="url(#coreGradient)" />
                <circle cx="200" cy="200" r="28" fill="var(--bg-color)" />
                <path d="M200 185 L213 192.5 L213 207.5 L200 215 L187 207.5 L187 192.5 Z" fill="var(--glow-color)"
                    opacity="0.8">
                    <animateTransform attributeName="transform" type="rotate" from="0 200 200" to="360 200 200"
                        dur="10s" repeatCount="indefinite" />
                </path>
            </g>

            <line x1="100" y1="200" x2="300" y2="200" stroke="var(--glow-color)" stroke-width="0.5" opacity="0.3">
                <animate attributeName="y1" values="120;280;120" dur="5s" repeatCount="indefinite" />
                <animate attributeName="y2" values="120;280;120" dur="5s" repeatCount="indefinite" />
            </line>
        </svg>
    </div>

    <script>
        const container = document.getElementById("jarvis-container");
        const mainStatus = document.getElementById("main-status");
        const envStatus = document.getElementById("env-status");
        const wsIndicator = document.getElementById("ws-indicator");
        const transcriptStatus = document.getElementById("last-transcript");
        const replyStatus = document.getElementById("last-reply");
        const errorStatus = document.getElementById("last-error");

        const pomodoroPanel = document.getElementById("pomodoro-panel");
        const pomodoroSession = document.getElementById("pomodoro-session");
        const pomodoroTimer = document.getElementById("pomodoro-timer");
        const pomodoroPhase = document.getElementById("pomodoro-phase");
        const pomodoroMotivation = document.getElementById("pomodoro-motivation");

        const runtimeStateLabels = {
            idle: "IDLE",
            listening: "LISTENING",
            transcribing: "TRANSCRIBING",
            thinking: "THINKING",
            replying: "REPLYING",
            error: "ERROR",
        };

        const pomodoroPhaseLabels = {
            idle: "IDLE",
            running: "RUNNING",
            paused: "PAUSED",
            completed: "COMPLETED",
            aborted: "ABORTED",
        };

        const pomodoroState = {
            phase: "idle",
            session: "",
            durationSeconds: 1500,
            anchorRemainingSeconds: 1500,
            anchorTimestampMs: Date.now(),
            motivation: "Start a session to lock in your focus.",
        };

        function setState(state) {
            container.classList.remove(
                "state-idle",
                "state-listening",
                "state-transcribing",
                "state-thinking",
                "state-replying",
                "state-error",
            );
            container.classList.add("state-" + state);
            mainStatus.textContent = runtimeStateLabels[state] || state.toUpperCase();
        }

        function setStatusMessage(message) {
            if (typeof message === "string" && message.trim()) {
                envStatus.textContent = message.trim();
            }
        }

        function clearError() {
            errorStatus.textContent = "";
            errorStatus.style.display = "none";
        }

        function showError(message) {
            errorStatus.textContent = `ERROR: ${message}`;
            errorStatus.style.display = "block";
        }

        function formatDuration(seconds) {
            const safeSeconds = Math.max(0, Number.isFinite(seconds) ? Math.floor(seconds) : 0);
            const minutes = Math.floor(safeSeconds / 60);
            const remainder = safeSeconds % 60;
            return `${String(minutes).padStart(2, "0")}:${String(remainder).padStart(2, "0")}`;
        }

        function isPomodoroFocusPhase(phase) {
            return phase === "running" || phase === "paused";
        }

        function currentPomodoroRemaining() {
            if (pomodoroState.phase !== "running") {
                return pomodoroState.anchorRemainingSeconds;
            }

            const elapsedSeconds = Math.floor((Date.now() - pomodoroState.anchorTimestampMs) / 1000);
            return Math.max(0, pomodoroState.anchorRemainingSeconds - elapsedSeconds);
        }

        function renderPomodoro() {
            const remainingSeconds = currentPomodoroRemaining();
            const effectivePhase =
                pomodoroState.phase === "running" && remainingSeconds === 0
                    ? "completed"
                    : pomodoroState.phase;

            pomodoroSession.textContent = (pomodoroState.session || "FOCUS SESSION").toUpperCase();
            pomodoroTimer.textContent = formatDuration(remainingSeconds);
            pomodoroPhase.textContent = pomodoroPhaseLabels[effectivePhase] || effectivePhase.toUpperCase();

            const isActiveSession = isPomodoroFocusPhase(effectivePhase);
            pomodoroPanel.classList.toggle("active", isActiveSession);
            document.body.classList.toggle("pomodoro-focus", isActiveSession);
        }

        function applyPomodoroUpdate(payload) {
            if (typeof payload.phase === "string" && payload.phase.trim()) {
                pomodoroState.phase = payload.phase.trim();
            }

            if (typeof payload.session === "string") {
                pomodoroState.session = payload.session.trim();
            }

            if (
                typeof payload.duration_seconds === "number" &&
                Number.isFinite(payload.duration_seconds) &&
                payload.duration_seconds > 0
            ) {
                pomodoroState.durationSeconds = Math.floor(payload.duration_seconds);
            }

            if (
                typeof payload.remaining_seconds === "number" &&
                Number.isFinite(payload.remaining_seconds) &&
                payload.remaining_seconds >= 0
            ) {
                pomodoroState.anchorRemainingSeconds = Math.floor(payload.remaining_seconds);
                pomodoroState.anchorTimestampMs = Date.now();
            }

            if (typeof payload.motivation === "string" && payload.motivation.trim()) {
                pomodoroState.motivation = payload.motivation.trim();
                pomodoroMotivation.textContent = pomodoroState.motivation;
            }

            if (!pomodoroMotivation.textContent.trim()) {
                pomodoroMotivation.textContent = "Start a session to lock in your focus.";
            }

            renderPomodoro();
        }

        function connectWebSocket() {
            const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
            const wsUrl = `${wsProtocol}://${window.location.host}/ws`;
            const socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                wsIndicator.textContent = "WS: CONNECTED";
                wsIndicator.style.color = "#00ff00";
                setStatusMessage("Connected to runtime");
                clearError();
            };

            socket.onmessage = (event) => {
                let payload = null;
                try {
                    payload = JSON.parse(event.data);
                } catch (_) {
                    return;
                }

                if (typeof payload.message === "string") {
                    setStatusMessage(payload.message);
                }

                const nextState = payload?.state;
                if (["idle", "listening", "transcribing", "thinking", "replying", "error"].includes(nextState)) {
                    setState(nextState);
                }
                if (nextState && nextState !== "error") {
                    clearError();
                }

                if (payload?.type === "transcript" && typeof payload.text === "string") {
                    transcriptStatus.textContent = `TRANSCRIPT: ${payload.text}`;
                }

                if (payload?.type === "assistant_reply" && typeof payload.text === "string") {
                    replyStatus.textContent = `REPLY: ${payload.text}`;
                }

                if (payload?.type === "pomodoro") {
                    applyPomodoroUpdate(payload);
                }

                if (payload?.type === "error") {
                    const message = typeof payload.message === "string" ? payload.message : "Unknown error";
                    showError(message);
                }
            };

            socket.onclose = () => {
                wsIndicator.textContent = "WS: RETRYING...";
                wsIndicator.style.color = "#ff4d00";
                setStatusMessage("Connection lost, retrying...");
                setTimeout(connectWebSocket, 2000);
            };

            socket.onerror = () => {
                wsIndicator.textContent = "WS: ERROR";
                wsIndicator.style.color = "#ff4d00";
            };
        }

        setInterval(() => {
            if (pomodoroState.phase === "running") {
                renderPomodoro();
            }
        }, 250);

        clearError();
        renderPomodoro();
        connectWebSocket();
    </script>
</body>

</html>
