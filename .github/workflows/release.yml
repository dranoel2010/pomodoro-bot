name: Build & Release (Debian Bookworm / Raspberry Pi) on tag

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            platform: linux/arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for ARM emulation)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Run your existing build script inside a Bookworm userspace for the target arch
      - name: Build in Debian Bookworm (${{ matrix.platform }})
        run: |
          set -euxo pipefail

          # Clean any previous output
          rm -rf dist build main.spec || true
          mkdir -p out

          docker run --rm \
            --platform=${{ matrix.platform }} \
            -v "$PWD":/src \
            -w /src \
            python:3.11-bookworm \
            bash -lc '
              set -euxo pipefail
              apt-get update
              apt-get install -y --no-install-recommends \
                build-essential \
                patchelf \
                binutils \
                git \
              && rm -rf /var/lib/apt/lists/*

              python3 -V
              python3 -m pip install --upgrade pip
              python3 -m pip install uv

              # Avoid QEMU/native CPU feature mis-detection when building llama-cpp-python
              # (prevents unsupported ARM dotprod instructions during arm64 emulated builds).
              export CMAKE_ARGS="${CMAKE_ARGS:-} -DGGML_NATIVE=OFF -DGGML_CPU_ARM_ARCH=armv8-a -DGGML_CPU_ALL_VARIANTS=OFF"

              chmod +x ./build.sh
              ./build.sh
            '

          # Preserve the artifact with an arch-specific name
          test -f dist/archive.tar.gz
          cp -v dist/archive.tar.gz "out/archive-${{ matrix.arch }}.tar.gz"

      - name: Upload build artifact (workflow artifact)
        uses: actions/upload-artifact@v4
        with:
          name: rpi-bookworm-${{ matrix.arch }}
          path: out/archive-${{ matrix.arch }}.tar.gz

  release:
    name: Create Release + Upload Assets
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: out

      - name: List downloaded artifacts
        run: |
          set -eux
          find out -type f -maxdepth 3 -print -ls

      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            out/**/archive-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
